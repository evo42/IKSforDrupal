(function(){function o(c,b){return k(c,function(a){return a===b})}function k(c,b){for(var a=0;a<c.length;a++)if(b(c[a]))return c[a];return null}function l(c,b){for(var a=[],d=0;d<c.length;d++)a.push(b(c[d]));return a}var f=(GENTICS.Aloha.TOC||{jQuery:jQuery}).jQuery,e=GENTICS.Aloha.TOC=new GENTICS.Aloha.Plugin("com.gentics.aloha.plugins.TOC");GENTICS.Aloha.TOC.languages=["en","de"];var m=null,p=[];e.init=function(){var c=e.settings;c.updateInterval=c.updateInterval||5E3;c.minEntries=c.minEntries||
0;e.initButtons();f(document).ready(function(){e.spawn()})};e.initButtons=function(){e.insertTocButton=new GENTICS.Aloha.ui.Button({iconClass:"GENTICS_button GENTICS_button_ul",size:"small",onclick:function(){e.insertAtSelection(m)},tooltip:this.i18n("button.addtoc.tooltip"),toggle:false});GENTICS.Aloha.FloatingMenu.addButton("GENTICS.Aloha.continuoustext",this.insertTocButton,GENTICS.Aloha.i18n(GENTICS.Aloha,"floatingmenu.tab.insert"),1)};e.register=function(c){m=c};e.generateId=function(c){var b;
if(typeof c=="object")b=f(c).text().replace(/[^a-zA-Z-]+/g,"-").replace(/^[^a-zA-Z]+/,"");else if(c)b=c;for(var a=0;;a++){var d=b;if(a)d+="-"+a;var g=document.getElementById(d);if(!g||typeof c=="object"&&g===c)return d}};e.outline=function(c){var b=[f()],a=[b];e.headings(c).each(function(){var d=f(this),g=this.nodeName.toLowerCase(),i=["h6","h5","h4","h3","h2","h1"];g=f.inArray(g,i);i=i.slice(g).join(",");i=[d.nextUntil(i).andSelf()];g=k(a,function(h){h=h[0];return!h.length||k(h,function(j){return d.get(0)===
j||f.contains(j,d.get(0))})});g.push(i);a.splice(0,o(a,g),i)});return b};e.editableContainers=function(){return f(l(GENTICS.Aloha.editables,function(c){return document.getElementById(c.getId())}))};e.headings=function(c){return c.find(":header").add(c.filter(":header"))};e.anchorFromLinkId=function(c,b){return b?c.find('a[href $= "#'+b+'"]'):f()};e.linkIdFromAnchor=function(c){return(c=c.attr("href"))?c.match(/#(.*?)$/)[1]:null};e.insertAtSelection=function(c){c=c||e.editableContainers();var b=e.generateId("toc"),
a=f("<ol class='toc_root'></ol>").attr("id",b).attr("contentEditable","false"),d=GENTICS.Aloha.Selection.getRangeObject(),g=f(document.getElementById(GENTICS.Aloha.activeEditable.getId()));GENTICS.Utils.Dom.insertIntoDOM(a,d,g);e.create(b).register(c).update().tickTock()};e.spawn=function(c,b){c=c||f("body");b=b||e.editableContainers();c.find("ol.toc_root").each(function(){var a=f(this).attr("id");if(!a){a=e.generateId("toc");f(this).attr("id",a)}e.create(a).register(b).tickTock()})};e.create=function(c){p.push(this);
return{id:c,$containers:f(),root:function(){return f(document.getElementById(this.id))},register:function(b){var a=this;a.$containers=a.$containers.add(b);a.$containers.filter(function(){return!f(this).data("com.gentics.aloha.plugins.TOC."+a.id+".listening")}).each(function(){var d=f(this);d.data("com.gentics.aloha.plugins.TOC."+a.id+".listening",true);d.bind("blur",function(){a.cleanupIds(d.get(0));a.update(d)})});return a},tickTock:function(b){var a=this;if(b=b||e.settings.updateInterval){window.setInterval(function(){a.register(e.editableContainers());
a.update()},b);return a}},cleanupIds:function(b){var a=[];e.headings(this.$containers).each(function(){var d=f(this).attr("id");if(d&&-1!=f.inArray(d,a)||b&&(f.contains(b,this)||b===this))f(this).attr("id",e.generateId(this));a.push(d)});return this},update:function(b){var a=this;b=b||a.$containers;b=e.outline(a.$containers);var d=[a.root()];d[d.length-1].empty();(function g(i){var h=[];l(i,function(j){var n=a.linkSection(j[0],d,h);d.push(n);g(j.slice(1));d.pop();h.push(n)})})(b.slice(1));b=a.root().attr("data-TOC-minEntries")||
e.settings.minEntries;a.root().find("li").length>=b?a.root().show():a.root().hide();return this},linkSection:function(b,a,d){var g=b.eq(0).attr("id");if(!g){g=e.generateId(b.get(0));b.eq(0).attr("id",g)}var i=this.root(),h=e.anchorFromLinkId(i,g);h.length||(h=f("<li><a/></li>"));h.find("a").attr("href","#"+g).text(b.eq(0).text());if(d[d.length-1])d[d.length-1].after(h);else if(a[a.length-1].get(0)==i.get(0))i.append(h);else{b=f("<ol/>").append(h);a[a.length-1].append(b)}return h}}}})();
