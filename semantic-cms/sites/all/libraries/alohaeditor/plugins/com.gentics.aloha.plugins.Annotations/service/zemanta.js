if(!GENTICS.Aloha.Annotations.Services)GENTICS.Aloha.Annotations.Services={};GENTICS.Aloha.Annotations.Services.zemanta=new GENTICS.Aloha.Annotations.Service("com.gentics.aloha.plugins.Annotations.service.zemanta");
GENTICS.Aloha.Annotations.Services.zemanta.init=function(){this.subscribeEvents();this.ApiEndpoint="http://api.zemanta.com/services/rest/0.0/";this.ApiMethod="zemanta.suggest_markup";this.ApiKey=false;if(GENTICS.Aloha.Annotations.settings.Services&&GENTICS.Aloha.Annotations.settings.Services.zemanta){if(GENTICS.Aloha.Annotations.settings.Services.zemanta.ApiEndpoint)this.ApiEndpoint=GENTICS.Aloha.Annotations.settings.Services.zemanta.ApiEndpoint;if(GENTICS.Aloha.Annotations.settings.Services.zemanta.ApiMethod)this.ApiMethod=
GENTICS.Aloha.Annotations.settings.Services.zemanta.ApiMethod;if(GENTICS.Aloha.Annotations.settings.Services.zemanta.ApiKey)this.ApiKey=GENTICS.Aloha.Annotations.settings.Services.zemanta.ApiKey}this.ApiKey||alert("ERROR: GENTICS.Aloha.Annotations.settings.Services.zemanta.ApiKey is not defined. Configure your Zemanta ApiKey first.");this.ResponseFormat="json";this.repositoryName=this.ApiKey?"zemanta/"+this.ApiKey:"zemanta/public"};
GENTICS.Aloha.Annotations.Services.zemanta.subscribeEvents=function(){var d=this;GENTICS.Aloha.EventRegistry.subscribe(GENTICS.Aloha,"editableDeactivated",function(n,k){if(GENTICS.Aloha.activeEditable){var h=false;if(GENTICS.Aloha.settings.proxyUrl)h=GENTICS.Aloha.settings.proxyUrl+d.ApiEndpoint;else alert("ERROR: GENTICS.Aloha.settings.proxyUrl not defined. Configure your AJAXproxy Plugin.");var l={method:d.ApiMethod,api_key:d.ApiKey,text:k.editable.getContents(),format:d.ResponseFormat,return_rdf_links:1,
markup_limit:25};jQuery.ajax({type:"POST",url:h,data:l,contentType:"text/plain",cache:false,beforeSend:function(b){b.setRequestHeader("Accept",d.ResponseFormat);b.setRequestHeader("X-Service-Info","Aloha Editor Annotation Service")},success:function(b){jQuery("input.as-input");var g=[];try{for(i=0;i<b.markup.links.length;i++)g.push(b.markup.links[i].anchor);for(i=0;i<g.length;i++){var a=g[i],e=jQuery("#edit-field-tags").parent().find(".at-term-list");a=Drupal.checkPlain(a);a=jQuery.trim(a);var f=
"",j=[];e.find(".at-term-text").each(function(m){var c=jQuery(this).text().replace(/["]/g,"");if(c.search(",")!=-1)c='"'+c+'"';f=m==0?c:f+", "+c;j.push(c)});if(a!=""&&jQuery.inArray(a,j)<0){e.append(Drupal.theme("activeTagsTermRemove",a));if(a.search(",")!=-1)a='"'+a+'"';f=f+", "+a;Drupal.attachBehaviors(e);e.parent().find("input.at-terms").val(f);e.parent().find(".at-term-entry").val("")}}}catch(o){b=new Date;b=b.getTime()}},error:function(){GENTICS.Aloha.Annotations.log("error","There was an error fetching the contents of the Zemanta service. ")}})}})};
