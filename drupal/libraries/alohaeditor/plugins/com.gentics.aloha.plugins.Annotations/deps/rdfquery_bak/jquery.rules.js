/*
 MIT license (MIT-LICENSE.txt)
 @version 1.0
*/
(function(a){var m=1;a.rdf.ruleset=function(c,e){return new a.rdf.ruleset.fn.init(c,e)};a.rdf.ruleset.fn=a.rdf.ruleset.prototype={init:function(c,e){var d;d=a.extend({},a.rdf.ruleset.defaults,e);c=c||[];this.baseURI=d.base;this.namespaces=a.extend({},d.namespaces);this.rules=[];for(d=0;d<c.length;d+=1)this.add.apply(this,c[d]);return this},base:function(c){if(c===undefined)return this.baseURI;else{this.baseURI=c;return this}},prefix:function(c,e){if(c===undefined)return this.namespaces;else if(e===
undefined)return this.namespaces[c];else{this.namespaces[c]=e;return this}},size:function(){return this.rules.length},add:function(c,e){var d;if(e===undefined&&c.rules)this.rules=this.rules.concat(c.rules);else{d=e===undefined&&c.lhs?c:a.rdf.rule(c,e,{namespaces:this.prefix(),base:this.base()});a.inArray(d,this.rules)===-1&&this.rules.push(d)}return this},run:function(c,e){var d,g,h,f=a.extend({limit:50},e).limit;do{h=c.size();for(d=0;d<this.rules.length;d+=1){g=this.rules[d];g.run(c)}f-=1}while(c.size()>
h&&f>0);return this}};a.rdf.ruleset.fn.init.prototype=a.rdf.ruleset.fn;a.rdf.ruleset.defaults={base:a.uri.base(),namespaces:{}};a.rdf.rule=function(c,e,d){return new a.rdf.rule.fn.init(c,e,d)};a.rdf.rule.fn=a.rdf.rule.prototype={init:function(c,e,d){var g=a.extend({},a.rdf.rule.defaults,d),h=[],f=false;if(typeof c==="string")c=[c];if(typeof e==="string")e=[e];this.lhs=a.map(c,function(b){if(a.isArray(b))return[b];else{if(!a.isFunction(b)){b=a.rdf.pattern(b,g);typeof b.subject==="string"&&h.push(b.subject);
typeof b.property==="string"&&h.push(b.property);typeof b.object==="string"&&h.push(b.object)}return b}});h=a.unique(h);this.rhs=a.isFunction(e)?e:a.map(e,function(b){b=a.rdf.pattern(b,g);if(typeof b.subject==="string"&&a.inArray(b.subject,h)===-1||typeof b.property==="string"&&a.inArray(b.property,h)===-1||typeof b.object==="string"&&a.inArray(b.object,h)===-1)throw"Bad Rule: Right-hand side of the rule contains a reference to an unbound wildcard";else if(b.subject.type==="bnode"||b.property.type===
"bnode"||b.object.type==="bnode")f=true;return b});this.rhsBlanks=f;this.cache={};return this},run:function(c,e){var d=a.rdf({databank:c}),g,h=a.extend({limit:50},e).limit,f,b,i,k,j,l,o=this.rhsBlanks,n;if(this.cache[c.id]===undefined)this.cache[c.id]={};for(f=0;f<this.lhs.length;f+=1){g=this.lhs[f];d=a.isArray(g)?d.filter.apply(d,g):a.isFunction(g)?d.filter.call(d,g):d.where(this.lhs[f])}do{g=d.length;n=d.sources();for(f=0;f<g;f+=1){j=n[f];l=true;k=this.cache[c.id];for(b=0;b<j.length;b+=1){if(k[j[b]]===
undefined)k[j[b]]={};else if(b===j.length-1)l=false;k=k[j[b]]}if(l){l=d.eq(f);if(o){for(b=0;b<this.rhs.length;b+=1){i=this.rhs[b];k=i.subject;j=i.property;i=i.object;if(k.type==="bnode")k=a.rdf.blank(""+k+m);if(j.type==="bnode")j=a.rdf.blank(""+j+m);if(i.type==="bnode")i=a.rdf.blank(""+i+m);i=a.rdf.pattern(k,j,i);l.add(i)}m+=1}else if(a.isFunction(this.rhs))l.map(this.rhs);else for(b=0;b<this.rhs.length;b+=1)l.add(this.rhs[b])}}h-=1}while(d.length>g&&h>0);return this}};a.rdf.rule.fn.init.prototype=
a.rdf.rule.fn;a.rdf.rule.defaults={base:a.uri.base(),namespaces:{}};a.extend(a.rdf.databank.fn,{reason:function(c,e){c.run(this,e);return this}});a.extend(a.rdf.fn,{reason:function(c,e){c.run(this.databank,e);return this}})})(jQuery);
