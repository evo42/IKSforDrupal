GENTICS.Aloha.Link=new GENTICS.Aloha.Plugin("com.gentics.aloha.plugins.Link");GENTICS.Aloha.Link.languages=["en","de","fr","ru","pl"];GENTICS.Aloha.Link.config=["a"];GENTICS.Aloha.Link.targetregex="";GENTICS.Aloha.Link.target="";GENTICS.Aloha.Link.cssclassregex="";GENTICS.Aloha.Link.cssclass="";GENTICS.Aloha.Link.objectTypeFilter=[];GENTICS.Aloha.Link.onHrefChange=null;
GENTICS.Aloha.Link.init=function(){if(GENTICS.Aloha.Link.settings.targetregex!=undefined)GENTICS.Aloha.Link.targetregex=GENTICS.Aloha.Link.settings.targetregex;if(GENTICS.Aloha.Link.settings.target!=undefined)GENTICS.Aloha.Link.target=GENTICS.Aloha.Link.settings.target;if(GENTICS.Aloha.Link.settings.cssclassregex!=undefined)GENTICS.Aloha.Link.cssclassregex=GENTICS.Aloha.Link.settings.cssclassregex;if(GENTICS.Aloha.Link.settings.cssclass!=undefined)GENTICS.Aloha.Link.cssclass=GENTICS.Aloha.Link.settings.cssclass;
if(GENTICS.Aloha.Link.settings.objectTypeFilter!=undefined)GENTICS.Aloha.Link.objectTypeFilter=GENTICS.Aloha.Link.settings.objectTypeFilter;if(GENTICS.Aloha.Link.settings.onHrefChange!=undefined)GENTICS.Aloha.Link.onHrefChange=GENTICS.Aloha.Link.settings.onHrefChange;this.createButtons();this.subscribeEvents();this.bindInteractions()};
GENTICS.Aloha.Link.createButtons=function(){var a=this;this.formatLinkButton=new GENTICS.Aloha.ui.Button({iconClass:"GENTICS_button GENTICS_button_a",size:"small",onclick:function(){a.formatLink()},tooltip:this.i18n("button.addlink.tooltip"),toggle:true});GENTICS.Aloha.FloatingMenu.addButton("GENTICS.Aloha.continuoustext",this.formatLinkButton,GENTICS.Aloha.i18n(GENTICS.Aloha,"floatingmenu.tab.format"),1);this.insertLinkButton=new GENTICS.Aloha.ui.Button({iconClass:"GENTICS_button GENTICS_button_a",
size:"small",onclick:function(){a.insertLink(false)},tooltip:this.i18n("button.addlink.tooltip"),toggle:false});GENTICS.Aloha.FloatingMenu.addButton("GENTICS.Aloha.continuoustext",this.insertLinkButton,GENTICS.Aloha.i18n(GENTICS.Aloha,"floatingmenu.tab.insert"),1);GENTICS.Aloha.FloatingMenu.createScope(this.getUID("link"),"GENTICS.Aloha.continuoustext");this.browser=new GENTICS.Aloha.ui.Browser;this.browser.setObjectTypeFilter(GENTICS.Aloha.Link.objectTypeFilter);this.browser.onSelect=function(b){a.hrefField.setItem(b);
a.hrefChange()};this.repositoryButton=new GENTICS.Aloha.ui.Button({iconClass:"GENTICS_button_big GENTICS_button_tree",size:"large",onclick:function(){a.browser.show()},tooltip:this.i18n("button.addlink.tooltip"),toggle:false});GENTICS.Aloha.FloatingMenu.addButton(this.getUID("link"),this.repositoryButton,this.i18n("floatingmenu.tab.link"),1);this.hrefField=new GENTICS.Aloha.ui.AttributeField({width:320,valueField:"url"});this.hrefField.setTemplate("<span><b>{name}</b><br/>{url}</span>");this.hrefField.setObjectTypeFilter(GENTICS.Aloha.Link.objectTypeFilter);
GENTICS.Aloha.FloatingMenu.addButton(this.getUID("link"),this.hrefField,this.i18n("floatingmenu.tab.link"),1);this.removeLinkButton=new GENTICS.Aloha.ui.Button({iconClass:"GENTICS_button GENTICS_button_a_remove",size:"small",onclick:function(){a.removeLink()},tooltip:this.i18n("button.removelink.tooltip")});GENTICS.Aloha.FloatingMenu.addButton(this.getUID("link"),this.removeLinkButton,this.i18n("floatingmenu.tab.link"),1)};
GENTICS.Aloha.Link.bindInteractions=function(){var a=this;this.hrefField.addListener("keyup",function(c,d){if(d.keyCode==27){var e=a.hrefField.getQueryValue();e[0]=="/"||e.match(/^.*\.([a-z]){2,4}$/i)||e[0]=="#"||e.match(/^htt.*/i)}a.hrefChange()});this.hrefField.addListener("blur",function(){this.getValue()==""&&a.removeLink()});for(var b=0;b<GENTICS.Aloha.editables.length;b++){GENTICS.Aloha.editables[b].obj.keydown(function(c){if(c.metaKey&&c.which==76){if(a.findLinkMarkup()){GENTICS.Aloha.FloatingMenu.userActivatedTab=
a.i18n("floatingmenu.tab.link");GENTICS.Aloha.FloatingMenu.doLayout();a.hrefField.focus()}else a.insertLink();return false}});GENTICS.Aloha.editables[b].obj.find("a").each(function(){jQuery(this).mouseenter(function(){GENTICS.Aloha.Log.debug(GENTICS.Aloha.Link,"mouse over link.");a.mouseOverLink=this;a.updateMousePointer()});jQuery(this).mouseleave(function(){GENTICS.Aloha.Log.debug(GENTICS.Aloha.Link,"mouse left link.");a.mouseOverLink=null;a.updateMousePointer()});jQuery(this).click(function(c){if(c.metaKey){GENTICS.Aloha.activeEditable.blur();
setTimeout(function(){location.href=c.target},0);c.stopPropagation();return false}})})}jQuery(document).keydown(function(c){GENTICS.Aloha.Log.debug(GENTICS.Aloha.Link,"Meta key down.");a.metaKey=c.metaKey;a.updateMousePointer()});jQuery(document).keyup(function(c){GENTICS.Aloha.Log.debug(GENTICS.Aloha.Link,"Meta key up.");a.metaKey=c.metaKey;a.updateMousePointer()})};
GENTICS.Aloha.Link.updateMousePointer=function(){if(this.metaKey&&this.mouseOverLink){GENTICS.Aloha.Log.debug(GENTICS.Aloha.Link,"set pointer");jQuery(this.mouseOverLink).removeClass("GENTICS_link_text");jQuery(this.mouseOverLink).addClass("GENTICS_link_pointer")}else{jQuery(this.mouseOverLink).removeClass("GENTICS_link_pointer");jQuery(this.mouseOverLink).addClass("GENTICS_link_text")}};
GENTICS.Aloha.Link.subscribeEvents=function(){var a=this;GENTICS.Aloha.EventRegistry.subscribe(GENTICS.Aloha,"selectionChanged",function(b,c){if(GENTICS.Aloha.activeEditable){var d=a.getEditableConfig(GENTICS.Aloha.activeEditable.obj);if(jQuery.inArray("a",d)!=-1){a.formatLinkButton.show();a.insertLinkButton.show();if(d=a.findLinkMarkup(c)){a.insertLinkButton.hide();a.formatLinkButton.setPressed(true);GENTICS.Aloha.FloatingMenu.setScope(a.getUID("link"));a.hrefField.setTargetObject(d,"href")}else{a.formatLinkButton.setPressed(false);
a.hrefField.setTargetObject(null)}GENTICS.Aloha.FloatingMenu.doLayout()}else{a.formatLinkButton.hide();a.insertLinkButton.hide()}}})};GENTICS.Aloha.Link.findLinkMarkup=function(a){if(typeof a=="undefined")a=GENTICS.Aloha.Selection.getRangeObject();return GENTICS.Aloha.activeEditable?a.findMarkup(function(){return this.nodeName.toLowerCase()=="a"},GENTICS.Aloha.activeEditable.obj):null};
GENTICS.Aloha.Link.formatLink=function(){var a=GENTICS.Aloha.Selection.getRangeObject();if(GENTICS.Aloha.activeEditable)this.findLinkMarkup(a)?this.removeLink():this.insertLink()};
GENTICS.Aloha.Link.insertLink=function(a){if(!this.findLinkMarkup(b)){GENTICS.Aloha.FloatingMenu.userActivatedTab=this.i18n("floatingmenu.tab.link");var b=GENTICS.Aloha.Selection.getRangeObject();b.isCollapsed()&&a!=false&&GENTICS.Utils.Dom.extendToWord(b);if(b.isCollapsed()){a=this.i18n("newlink.defaulttext");var c=jQuery('<a href="">'+a+"</a>");GENTICS.Utils.Dom.insertIntoDOM(c,b,jQuery(GENTICS.Aloha.activeEditable.obj));b.startContainer=b.endContainer=c.contents().get(0);b.startOffset=0;b.endOffset=
a.length}else{c=jQuery('<a href=""></a>');GENTICS.Utils.Dom.addMarkup(b,c,false)}b.select();this.hrefField.focus();this.hrefChange()}};GENTICS.Aloha.Link.removeLink=function(){var a=GENTICS.Aloha.Selection.getRangeObject(),b=this.findLinkMarkup();if(b){GENTICS.Utils.Dom.removeFromDOM(b,a,true);GENTICS.Aloha.activeEditable.obj[0].focus();a.select()}};
GENTICS.Aloha.Link.hrefChange=function(){this.hrefField.setAttribute("target",this.target,this.targetregex,this.hrefField.getQueryValue());this.hrefField.setAttribute("class",this.cssclass,this.cssclassregex,this.hrefField.getQueryValue());typeof this.onHrefChange=="function"&&this.onHrefChange.call(this,this.hrefField.getTargetObject(),this.hrefField.getQueryValue(),this.hrefField.getItem());GENTICS.Aloha.EventRegistry.trigger(new GENTICS.Aloha.Event("hrefChanged",GENTICS.Aloha,{obj:this.hrefField.getTargetObject(),
href:this.hrefField.getQueryValue(),item:this.hrefField.getItem()}))};GENTICS.Aloha.Link.makeClean=function(a){a.find("a").each(function(){jQuery(this).removeClass("GENTICS_link_pointer");jQuery(this).removeClass("GENTICS_link_text")})};
